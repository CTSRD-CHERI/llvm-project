; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: %cheri_purecap_llc -cheri-cap-table-abi=pcrel -o - -O0 %s | FileCheck %s
; RUN: not %cheri_purecap_llc -cheri-cap-table-abi=legacy -o - -O0 %s 2>&1 | FileCheck %s -check-prefix LEGACY
; LEGACY: Cannot select: {{.+}}: iFATPTR{{128|256}} = GlobalTLSAddress<i1 addrspace(200)* @__tls_guard> 0

@__tls_guard = external thread_local addrspace(200) global i1 #0

define void @store() nounwind {
; CHECK-LABEL: store:
; CHECK:       # %bb.0:
; CHECK-NEXT:    cincoffset $c11, $c11, -[[STACKFRAME_SIZE:16|32]]
; CHECK-NEXT:    csc $c17, $zero, 0($c11)
; CHECK-NEXT:    lui $1, %pcrel_hi(_CHERI_CAPABILITY_TABLE_-8)
; CHECK-NEXT:    daddiu $1, $1, %pcrel_lo(_CHERI_CAPABILITY_TABLE_-4)
; CHECK-NEXT:    cgetpccincoffset $c1, $1
; CHECK-NEXT:    lui $1, %captab_tlsgd_hi(__tls_guard)
; CHECK-NEXT:    daddiu $1, $1, %captab_tlsgd_lo(__tls_guard)
; CHECK-NEXT:    cincoffset $c2, $c1, $1
; CHECK-NEXT:    csetbounds $c3, $c2, 16
; CHECK-NEXT:    clcbi $c12, %capcall20(__tls_get_addr)($c1)
; CHECK-NEXT:    cgetnull $c13
; CHECK-NEXT:    cjalr $c12, $c17
; CHECK-NEXT:    nop
; CHECK-NEXT:    daddiu $1, $zero, 1
; CHECK-NEXT:    csb $1, $zero, 0($c3)
; CHECK-NEXT:    clc $c17, $zero, 0($c11)
; CHECK-NEXT:    cincoffset $c11, $c11, [[STACKFRAME_SIZE]]
; CHECK-NEXT:    cjr $c17
; CHECK-NEXT:    nop
  store i1 true, i1 addrspace(200)* @__tls_guard
  ret void
}

define i1 @load() nounwind {
; CHECK-LABEL: load:
; CHECK:       # %bb.0:
; CHECK-NEXT:    cincoffset $c11, $c11, -[[STACKFRAME_SIZE:16|32]]
; CHECK-NEXT:    csc $c17, $zero, 0($c11)
; CHECK-NEXT:    lui $1, %pcrel_hi(_CHERI_CAPABILITY_TABLE_-8)
; CHECK-NEXT:    daddiu $1, $1, %pcrel_lo(_CHERI_CAPABILITY_TABLE_-4)
; CHECK-NEXT:    cgetpccincoffset $c1, $1
; CHECK-NEXT:    lui $1, %captab_tlsgd_hi(__tls_guard)
; CHECK-NEXT:    daddiu $1, $1, %captab_tlsgd_lo(__tls_guard)
; CHECK-NEXT:    cincoffset $c2, $c1, $1
; CHECK-NEXT:    csetbounds $c3, $c2, 16
; CHECK-NEXT:    clcbi $c12, %capcall20(__tls_get_addr)($c1)
; CHECK-NEXT:    cgetnull $c13
; CHECK-NEXT:    cjalr $c12, $c17
; CHECK-NEXT:    nop
; CHECK-NEXT:    clb $2, $zero, 0($c3)
; CHECK-NEXT:    clc $c17, $zero, 0($c11)
; CHECK-NEXT:    cincoffset $c11, $c11, [[STACKFRAME_SIZE]]
; CHECK-NEXT:    cjr $c17
; CHECK-NEXT:    nop
  %arg = load i1, i1 addrspace(200)* @__tls_guard
  ret i1 %arg
}
