; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: %cheri_purecap_llc -O0 %s -o - | FileCheck %s
; Reduced test case for index.c no longer compiling after memset optimization
; See https://github.com/CTSRD-CHERI/llvm/issues/265
%struct.am = type { %struct.n, %struct.m, [8 x i8] }
%struct.n = type { ptr addrspace(200) }
%struct.m = type { i32, i32, i8, i8, i8, i8, i8, i32, i32 }

@q = common addrspace(200) global %struct.am zeroinitializer, align 16
@p = common addrspace(200) global %struct.am zeroinitializer, align 16

define void @r() noinline nounwind optnone {
; Check that we do a 24-byte copy as a capability load/store followed by a dword load / store
; CHECK-LABEL: r:
; CHECK:       # %bb.0:
; CHECK-NEXT:    lui $1, %pcrel_hi(_CHERI_CAPABILITY_TABLE_-8)
; CHECK-NEXT:    daddiu $1, $1, %pcrel_lo(_CHERI_CAPABILITY_TABLE_-4)
; CHECK-NEXT:    cgetpccincoffset $c1, $1
; CHECK-NEXT:    clcbi $c2, %captab20(q)($c1)
; CHECK-NEXT:    clcbi $c1, %captab20(p)($c1)
; CHECK-NEXT:    cld $1, $zero, 32($c1)
; CHECK-NEXT:    csd $1, $zero, 32($c2)
; CHECK-NEXT:    clc $c1, $zero, 16($c1)
; CHECK-NEXT:    csc $c1, $zero, 16($c2)
; CHECK-NEXT:    cjr $c17
; CHECK-NEXT:    nop
;
  call void @llvm.memcpy.p200.p200.i64(ptr addrspace(200) align 16 getelementptr inbounds (%struct.am, ptr addrspace(200) @q, i32 0, i32 1), ptr addrspace(200) align 16 getelementptr inbounds (%struct.am, ptr addrspace(200) @p, i32 0, i32 1), i64 24, i1 false)
  ret void
}

declare void @llvm.memcpy.p200.p200.i64(ptr addrspace(200) noalias nocapture writeonly, ptr addrspace(200) noalias nocapture readonly, i64, i1 immarg)
