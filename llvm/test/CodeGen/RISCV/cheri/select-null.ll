; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; Selecting NULL would previously cause machine verifier errors because all
; uses of (inttoptr (i64)) we being replace with $c0 if we encounted it
; in a CopyToReg. This is not legal for most other nodes and results in errors
; later on.
; Check that integer pointers work:
; RUN: sed 's/addrspace(200)/addrspace(0)/g' %s | %riscv64_cheri_llc -o - -O2 - | FileCheck %s --check-prefix RV64
; RUN: %riscv64_cheri_purecap_llc %s -o - -O2 | FileCheck %s --check-prefix PURECAP
; RUNs: /Users/alex/cheri/llvm-project/cmake-build-debug/bin/llc -target-abi l64pc128 -mattr=+cap-mode -mtriple=riscv64-unknown-freebsd -mattr=+xcheri -verify-machineinstrs /Users/alex/cheri/llvm-project/llvm/test/CodeGen/RISCV/cheri/phi-not-live-out-regression.ll -o -
; ModuleID = '/Users/alex/cheri/llvm-project/llvm/test/CodeGen/RISCV/cheri/jemalloc_crash.ll'
;source_filename = "/Users/alex/cheri/llvm-project/llvm/test/CodeGen/RISCV/cheri/jemalloc_crash.ll"
;target datalayout = "e-m:e-pf200:128:128:128:64-p:64:64-i64:64-i128:128-n64-S128-A200-P200-G200"
; target triple = "riscv64-unknown-freebsd"

declare void @barney(i8 addrspace(200)*) local_unnamed_addr addrspace(200)
define i8 addrspace(200)* @eggs(i1 %cond) local_unnamed_addr addrspace(200) #0 {
; RV64-LABEL: eggs:
; RV64:       # %bb.0: # %bb
; RV64-NEXT:    addi sp, sp, -16
; RV64-NEXT:    sd ra, 8(sp) # 8-byte Folded Spill
; RV64-NEXT:    sd s0, 0(sp) # 8-byte Folded Spill
; RV64-NEXT:    andi a0, a0, 1
; RV64-NEXT:    mv s0, zero
; RV64-NEXT:    bnez a0, .LBB0_2
; RV64-NEXT:  # %bb.1: # %bb
; RV64-NEXT:    addi s0, zero, 32
; RV64-NEXT:  .LBB0_2: # %bb
; RV64-NEXT:    mv a0, zero
; RV64-NEXT:    call barney@plt
; RV64-NEXT:    mv a0, s0
; RV64-NEXT:    ld s0, 0(sp) # 8-byte Folded Reload
; RV64-NEXT:    ld ra, 8(sp) # 8-byte Folded Reload
; RV64-NEXT:    addi sp, sp, 16
; RV64-NEXT:    ret
;
; PURECAP-LABEL: eggs:
; PURECAP:       # %bb.0: # %bb
; PURECAP-NEXT:    cincoffset csp, csp, -32
; PURECAP-NEXT:    csc cra, 16(csp) # 16-byte Folded Spill
; PURECAP-NEXT:    csc cs0, 0(csp) # 16-byte Folded Spill
; PURECAP-NEXT:    andi a0, a0, 1
; PURECAP-NEXT:    cmove cs0, cnull
; PURECAP-NEXT:    bnez a0, .LBB0_2
; PURECAP-NEXT:  # %bb.1: # %bb
; PURECAP-NEXT:    cincoffset cs0, cnull, 32
; PURECAP-NEXT:  .LBB0_2: # %bb
; PURECAP-NEXT:    cmove ca0, cnull
; PURECAP-NEXT:    ccall barney
; PURECAP-NEXT:    cmove ca0, cs0
; PURECAP-NEXT:    clc cs0, 0(csp) # 16-byte Folded Reload
; PURECAP-NEXT:    clc cra, 16(csp) # 16-byte Folded Reload
; PURECAP-NEXT:    cincoffset csp, csp, 32
; PURECAP-NEXT:    cret
bb:
  %tmp1.0 = select i1 %cond, i8 addrspace(200)* null, i8 addrspace(200)* inttoptr (i64 32 to i8 addrspace(200)*)
  tail call void @barney(i8 addrspace(200)* null)
  ret i8 addrspace(200)* %tmp1.0
}

attributes #0 = { nounwind }
