// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py
// RUN: %cheri_cc1 -Wno-cheri -disable-O0-optnone -emit-llvm %s -o - \
// RUN:   | opt -S -passes=mem2reg | FileCheck %s

// This would previously not treat the reference use as a dereference,
// resulting in Sema erroneously think the MemberExpr had type 'char *' and
// thus that the cast was a no-op, but during CodeGen it would instead get a
// 'char * __capability' and crash.

extern "C" {

// CHECK-LABEL: @addrof(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[TMP0:%.*]] = addrspacecast ptr addrspace(200) [[C:%.*]] to ptr
// CHECK-NEXT:    ret ptr [[TMP0]]
//
char *addrof(char & __capability c) {
  return (char *)&c;
}

}; // extern "C"
