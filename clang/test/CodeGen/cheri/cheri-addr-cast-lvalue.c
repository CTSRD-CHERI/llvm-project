// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py
// RUN: %cheri_cc1 -o - -emit-llvm %s | %cheri_FileCheck %s
// Previously return (char *)(__cheri_addr long)cap; would fail with an assertion
// Due to incorrect constant expression evaluation for __cheri_addr/__cheri_offset
// https://github.com/CTSRD-CHERI/llvm-project/issues/360


// CHECK-LABEL: @test_ptr(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[PTR_ADDR:%.*]] = alloca i8*, align 8
// CHECK-NEXT:    store i8* [[PTR:%.*]], i8** [[PTR_ADDR]], align 8
// CHECK-NEXT:    [[TMP0:%.*]] = load i8*, i8** [[PTR_ADDR]], align 8
// CHECK-NEXT:    [[TMP1:%.*]] = ptrtoint i8* [[TMP0]] to i64
// CHECK-NEXT:    [[TMP2:%.*]] = inttoptr i64 [[TMP1]] to i8*
// CHECK-NEXT:    ret i8* [[TMP2]]
//
char* test_ptr(void * ptr) {
  return (char *)(long)ptr;
}

// CHECK-LABEL: @test_cap_addr(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[CAP_ADDR:%.*]] = alloca i8 addrspace(200)*, align [[#CAP_SIZE]]
// CHECK-NEXT:    store i8 addrspace(200)* [[CAP:%.*]], i8 addrspace(200)** [[CAP_ADDR]], align [[#CAP_SIZE]]
// CHECK-NEXT:    [[TMP0:%.*]] = load i8 addrspace(200)*, i8 addrspace(200)** [[CAP_ADDR]], align [[#CAP_SIZE]]
// CHECK-NEXT:    [[TMP1:%.*]] = call i64 @llvm.cheri.cap.address.get.i64(i8 addrspace(200)* [[TMP0]])
// CHECK-NEXT:    [[TMP2:%.*]] = inttoptr i64 [[TMP1]] to i8*
// CHECK-NEXT:    ret i8* [[TMP2]]
//
char* test_cap_addr(void *__capability cap) {
  return (char *)(__cheri_addr long)cap;
}

// CHECK-LABEL: @test_cap_offset(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[CAP_ADDR:%.*]] = alloca i8 addrspace(200)*, align [[#CAP_SIZE]]
// CHECK-NEXT:    store i8 addrspace(200)* [[CAP:%.*]], i8 addrspace(200)** [[CAP_ADDR]], align [[#CAP_SIZE]]
// CHECK-NEXT:    [[TMP0:%.*]] = load i8 addrspace(200)*, i8 addrspace(200)** [[CAP_ADDR]], align [[#CAP_SIZE]]
// CHECK-NEXT:    [[TMP1:%.*]] = call i64 @llvm.cheri.cap.offset.get.i64(i8 addrspace(200)* [[TMP0]])
// CHECK-NEXT:    [[TMP2:%.*]] = inttoptr i64 [[TMP1]] to i8*
// CHECK-NEXT:    ret i8* [[TMP2]]
//
char* test_cap_offset(void *__capability cap) {
  return (char *)(__cheri_offset long)cap;
}
