// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py
// RUN: %cheri_purecap_cc1 -emit-llvm -o - -O2 %s | %cheri_FileCheck %s -check-prefixes CHECK,CHECK-%cheri_type
// Check that this doesn't crash when emitting assembly:
// RUN: %cheri_purecap_cc1 -S -o - -O2 %s | %cheri_FileCheck %s -check-prefixes ASM

// The memcpy here was turned into a memset zero with capability type which would then crash the compiler
// since only integers and vectors were handled.

#define DEFAULT_UMUTEX	{0,0,{0,0},0,0,{0,0}}

typedef __UINT32_TYPE__ __lwpid_t;
typedef __UINT32_TYPE__ __uint32_t;
typedef __UINTPTR_TYPE__ __uintptr_t;

struct umutex {
	volatile __lwpid_t	m_owner;	/* Owner of the mutex */
	__uint32_t		m_flags;	/* Flags of the mutex */
	__uint32_t		m_ceilings[2];	/* Priority protect ceiling */
	__uintptr_t		m_rb_lnk;	/* Robust linkage */
	__uint32_t		m_pad;
	__uint32_t		m_spare[2];
};
// CHECK-CHERI128: %struct.umutex = type { i32, i32, [2 x i32], i8 addrspace(200)*, i32, [2 x i32] }
// CHECK-CHERI256: %struct.umutex = type { i32, i32, [2 x i32], i8 addrspace(200)*, i32, [2 x i32], [20 x i8]  }

// CHECK-CHERI128: @_thr_umutex_init.default_mtx = internal addrspace(200) constant %struct.umutex zeroinitializer, align [[#CAP_SIZE]]
// Without end padding for cheri256?
// CHECK-CHERI256: @_thr_umutex_init.default_mtx = internal addrspace(200) constant { i32, i32, [2 x i32], i8 addrspace(200)*, i32, [2 x i32] } zeroinitializer, align [[#CAP_SIZE]]

// CHECK-LABEL: @_thr_umutex_init(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[TMP0:%.*]] = bitcast [[STRUCT_UMUTEX:%.*]] addrspace(200)* [[MTX:%.*]] to i8 addrspace(200)*
// CHECK-NEXT:    tail call void @llvm.memcpy.p200i8.p200i8.i64(i8 addrspace(200)* align [[#CAP_SIZE]] [[TMP0]], i8 addrspace(200)* align [[#CAP_SIZE]] bitcast ({{.+}} addrspace(200)* @_thr_umutex_init.default_mtx to i8 addrspace(200)*), i64 {{48|96}}, i1 true), !tbaa.struct !2
// CHECK-NEXT:    ret void
//
void _thr_umutex_init(struct umutex *mtx)
{
	static const struct umutex default_mtx = DEFAULT_UMUTEX;
	*mtx = default_mtx;
// ASM:	csc	$cnull, $zero, 0($c3)
// ASM:	csc	$cnull, $zero, {{32|64}}($c3)
// ASM:	cjr	$c17
// ASM:	csc	$cnull, $zero, {{16|32}}($c3)
}
